# Инструкция по отладке бота Nota

В этом документе описаны шаги для остановки фоновых процессов бота и запуска его в режиме отладки для выявления и исправления ошибок.

## 1. Остановка фоновых процессов

Если бот запущен в фоновом режиме (через `run_forever.sh` или как systemd-сервис), сначала необходимо остановить все фоновые процессы:

```bash
./stop_background_bot.sh
```

Скрипт выполнит следующие действия:
- Найдет и остановит все процессы `run_forever.sh`, которые перезапускают бота
- Остановит все запущенные экземпляры `bot.py`
- Проверит наличие systemd-сервиса и выдаст рекомендации по его остановке
- Создаст детальный лог-файл остановки в директории `logs/`

## 2. Запуск бота в режиме отладки

После остановки всех фоновых процессов, запустите бота в режиме отладки:

```bash
./debug_bot.sh
```

Этот скрипт:
- Активирует виртуальное окружение Python
- Установит необходимые переменные окружения для отладки
- Запустит бота с более подробным логированием
- Покажет все сообщения в консоли в реальном времени

## 3. Анализ логов

Для анализа логов бота используйте специальный скрипт:

```bash
./debug_logs.sh [опции]
```

### Основные опции:

- `-l` или `--live`: Мониторинг логов в реальном времени
- `-e` или `--errors`: Показать только ошибки
- `-w` или `--warnings`: Показать только предупреждения
- `-f FILE` или `--file FILE`: Анализировать конкретный файл лога
- `-g PATTERN` или `--grep PATTERN`: Поиск по шаблону

### Примеры использования:

```bash
# Мониторинг последнего лога в реальном времени
./debug_logs.sh -l

# Показать только ошибки из последнего лога
./debug_logs.sh -e

# Мониторинг ошибок в реальном времени
./debug_logs.sh -e -l

# Анализ конкретного файла
./debug_logs.sh -f logs/bot_2025-05-15.log

# Поиск по шаблону
./debug_logs.sh -g "OCR|Vision API"
```

## 4. Возвращение к обычному режиму работы

После завершения отладки:

1. Нажмите `Ctrl+C` для остановки отладочного режима
2. Запустите бота в обычном режиме:

```bash
./run_bot.sh           # Обычный запуск
# или
./run_forever.sh       # Запуск с автоматическим перезапуском при сбоях
# или
sudo systemctl start nota-bot  # Если настроен systemd-сервис
```

## Дополнительная информация

### Расположение логов
Логи хранятся в директории `logs/`. При запуске в отладочном режиме создается специальный файл лога с префиксом `debug_`.

### Известные проблемы
- Если процессы не удается остановить через `stop_background_bot.sh`, попробуйте использовать `kill -9` вручную для PID процессов.
- При проблемах с доступом к systemd-сервисам используйте команду `sudo`.

### Контакты для поддержки
Если у вас возникли проблемы с отладкой, обратитесь к разработчикам:
- Email: support@example.com
- GitHub: https://github.com/username/Nota-v3 