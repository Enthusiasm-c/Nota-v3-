# Исправление проблемы отсутствия кнопки "Отправить накладную" после редактирования

## Обнаруженная проблема

В системе была выявлена проблема: после внесения изменений в накладную кнопка "Отправить накладную" (✅ Подтвердить) не появлялась в интерфейсе, даже если накладная не содержала ошибок.

## Диагностика

На основе анализа кода и создания диагностического скрипта удалось выявить следующие ключевые моменты:

1. Кнопка "Отправить накладную" (✅ Подтвердить) отображается только в том случае, если параметр `has_errors` равен `False` при формировании клавиатуры через функцию `build_main_kb`.

2. Параметр `has_errors` определяется в функции `build_report` в файле `app/formatters/report.py`, которая корректно определяет наличие ошибок в накладной.

3. **Основная причина**: В файле `app/handlers/edit_core.py` (строки 175-180) было обнаружено принудительное изменение этого параметра с `False` на `True`:

```python
# Проблемный код:
if not has_errors and (unknown_count > 0 or partial_count > 0):
    logger.critical(f"ОТЛАДКА-ЯДРО: Принудительно устанавливаем has_errors=True")
    has_errors = True
```

Эта проверка всегда принудительно устанавливала `has_errors = True`, если в инвойсе присутствовали позиции с параметрами `unknown` или `partial`, даже если функция `build_report` определила, что фактических ошибок нет.

## Примененное решение

Было выполнено следующее исправление:

1. Удален код, который принудительно устанавливал флаг `has_errors` в `True`:

```python
# ИСПРАВЛЕНИЕ: Удаляем принудительную установку has_errors=True
# Было: if not has_errors and (unknown_count > 0 or partial_count > 0):
#     logger.critical(f"ОТЛАДКА-ЯДРО: Принудительно устанавливаем has_errors=True")
#     has_errors = True

# Позволяем функции build_report самостоятельно определять наличие ошибок
# и не переопределяем ее результат
```

2. Создан тестовый скрипт `test_fixed_edit_invoice.py` для проверки корректности работы всего процесса определения статуса ошибок и формирования клавиатуры.

## Результаты тестирования

Тест подтвердил, что:

1. Функция `build_report` корректно определяет статус `has_errors = False` для инвойса без ошибок.
2. Клавиатура, созданная функцией `build_main_kb`, включает кнопку "✅ Подтвердить" при отсутствии ошибок.
3. После исправления, при отсутствии ошибок в инвойсе, кнопка "Отправить накладную" отображается корректно.

## Заключение

Внесенное исправление устраняет проблему отсутствия кнопки "Отправить накладную" после редактирования инвойса без ошибок, позволяя пользователям успешно завершить процесс редактирования и отправки накладной. 