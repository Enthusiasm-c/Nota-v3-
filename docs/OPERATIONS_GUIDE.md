# Руководство по эксплуатации Nota AI Bot

Это руководство предназначено для системных администраторов и инженеров, отвечающих за развертывание, настройку, эксплуатацию и обслуживание Nota AI Bot.

## Содержание

- [1. Развертывание](#1-развертывание)
  - [Предварительные требования](#предварительные-требования)
  - [Развертывание с использованием Docker (рекомендуемый способ)](#развертывание-с-использованием-docker-рекомендуемый-способ)
    - [Клонирование репозитория](#клонирование-репозитория)
    - [Настройка переменных окружения](#настройка-переменных-окружения)
    - [Сборка и запуск контейнеров](#сборка-и-запуск-контейнеров)
    - [Проверка работоспособности](#проверка-работоспособности)
  - [Развертывание на Linux-сервере (без Docker, если необходимо)](#развертывание-на-linux-сервере-без-docker-если-необходимо)
    - [Установка зависимостей](#установка-зависимостей)
    - [Настройка systemd сервиса](#настройка-systemd-сервиса)
- [2. Конфигурация](#2-конфигурация)
  - [Переменные окружения](#переменные-окружения-1)
  - [Файлы данных](#файлы-данных)
  - [Настройки в `app/config/settings.py`](#настройки-в-appconfigsettingspy)
- [3. Управление сервисом](#3-управление-сервисом)
  - [Docker Compose](#docker-compose)
  - [Systemd](#systemd)
- [4. Мониторинг и метрики](#4-мониторинг-и-метрики)
  - [Логирование](#логирование)
  - [Prometheus и Grafana](#prometheus-и-grafana)
  - [Основные метрики для мониторинга](#основные-метрики-для-мониторинга)
- [5. Обслуживание](#5-обслуживание)
  - [Резервное копирование](#резервное-копирование)
  - [Управление алиасами](#управление-алиасами)
  - [Очистка старых логов и данных](#очистка-старых-логов-и-данных)
  - [Обновление до новой версии](#обновление-до-новой-версии)
- [6. Технические аспекты](#6-технические-аспекты)
  - [Обработка ошибок API](#обработка-ошибок-api)
  - [Оптимизации производительности](#оптимизации-производительности)
- [7. Устранение неполадок](#7-устранение-неполадок)
  - [Общие проблемы](#общие-проблемы)
  - [Анализ логов для отладки на сервере](#анализ-логов-для-отладки-на-сервере)
- [8. История изменений (Changelog)](#8-история-изменений-changelog)
- [9. Известные проблемы и ограничения](#9-известные-проблемы-и-ограничения)

## 1. Развертывание

### Предварительные требования

-   Сервер на базе Linux (рекомендуется Ubuntu 20.04+).
-   Для Docker-развертывания: Docker и Docker Compose установлены.
-   Для не-Docker развертывания: Python 3.10+, Redis.
-   Доступ к серверу через SSH.

### Развертывание с использованием Docker (рекомендуемый способ)

(Основано на `DEPLOYMENT.md`)

#### Клонирование репозитория
```bash
git clone <URL_РЕПОЗИТОРИЯ>
cd Nota-v3-
# git checkout <нужная_ветка_или_тег> # Например, main или конкретный релиз
```

#### Настройка переменных окружения
Скопируйте `.env.docker` (или `.env.example` / `.env.minimal` в зависимости от конфигурации) в `.env`:
```bash
cp .env.docker .env # или другой .env-шаблон
# Отредактируйте .env файл и укажите все необходимые переменные
```
Ключевые переменные см. в разделе [Конфигурация](#2-конфигурация).

#### Сборка и запуск контейнеров
```bash
docker-compose up -d
```
Это запустит сервисы, определенные в `docker-compose.yml` (обычно `nota-bot`, `redis`, опционально `prometheus`, `grafana`).

#### Проверка работоспособности
```bash
docker-compose ps
# Все сервисы должны иметь статус "Up" или "running"

docker-compose logs -f nota-bot # Просмотр логов бота
```

### Развертывание на Linux-сервере (без Docker, если необходимо)

(Основано на `docs/PROJECT_OVERVIEW.md` и `docs/developer_guide/README.md`)

#### Установка зависимостей
1.  Установите Python 3.10+, Redis.
2.  Клонируйте репозиторий.
3.  Создайте виртуальное окружение и установите зависимости:
    ```bash
    python -m venv venv
    source venv/bin/activate
    pip install -r requirements.txt
    ```
4.  Настройте файл `.env`.

#### Настройка systemd сервиса
1.  Создайте или отредактируйте файл юнита systemd (например, `nota-bot.service` или используйте `deploy/nota.service` как шаблон).
    Пример содержания `nota-bot.service`:
    ```ini
    [Unit]
    Description=Nota AI Telegram Bot
    After=network.target redis-server.service

    [Service]
    User=<ваш_пользователь>
    WorkingDirectory=/path/to/Nota-v3-
    ExecStart=/path/to/Nota-v3-/venv/bin/python bot.py
    Restart=always
    EnvironmentFile=/path/to/Nota-v3-/.env

    [Install]
    WantedBy=multi-user.target
    ```
2.  Скопируйте его в `/etc/systemd/system/`.
3.  Включите и запустите сервис:
    ```bash
    sudo systemctl daemon-reload
    sudo systemctl enable nota-bot
    sudo systemctl start nota-bot
    ```

## 2. Конфигурация

### Переменные окружения
Все основные настройки производятся через переменные окружения, загружаемые из файла `.env`. Образцы файлов: `.env.example`, `.env.minimal`, `.env.docker`.

Ключевые переменные:
-   `TELEGRAM_TOKEN`: Токен Telegram бота.
-   `OPENAI_OCR_KEY`, `OPENAI_CHAT_KEY`: Ключи API OpenAI.
-   `OPENAI_ASSISTANT_ID`: ID ассистента OpenAI.
-   `SYRVE_API_URL`, `SYRVE_LOGIN`, `SYRVE_PASSWORD`, etc.: Данные для интеграции с Syrve.
-   `REDIS_URL`: URL для подключения к Redis (например, `redis://localhost:6379/0`).
-   `ADMIN_CHAT_ID`: ID чата администратора для системных уведомлений.
-   `LOG_LEVEL`: Уровень логирования (например, `INFO`, `DEBUG`).
-   `PROMETHEUS_PORT`: Порт для метрик Prometheus (если используется).

### Файлы данных
(См. `docs/PROJECT_OVERVIEW.md` - "Настройка конфигурации")
-   `data/aliases.csv`: Алиасы продуктов.
-   `data/base_products.csv`: Каталог продуктов.
-   `data/base_suppliers.csv`: Каталог поставщиков.
Эти файлы обычно загружаются при старте бота.

### Настройки в `app/config/settings.py`
Файл `app/config/settings.py` (или `app/config.py`) загружает переменные окружения и может содержать другие константы и настройки приложения.

## 3. Управление сервисом

### Docker Compose
-   Запуск: `docker-compose up -d`
-   Остановка: `docker-compose down`
-   Перезапуск: `docker-compose restart nota-bot` (или конкретного сервиса)
-   Просмотр логов: `docker-compose logs -f nota-bot`
-   Статус сервисов: `docker-compose ps`

### Systemd
-   Запуск: `sudo systemctl start nota-bot`
-   Остановка: `sudo systemctl stop nota-bot`
-   Перезапуск: `sudo systemctl restart nota-bot`
-   Просмотр логов: `sudo journalctl -u nota-bot -f`
-   Статус сервиса: `sudo systemctl status nota-bot`

## 4. Мониторинг и метрики

(Основано на `docs/PROJECT_OVERVIEW.md` - "Мониторинг и метрики")

### Логирование
-   Основной способ мониторинга. Логи пишутся в stdout (в Docker) или в файлы (если настроено, см. `logs/`).
-   Уровень логирования настраивается переменной `LOG_LEVEL`.
-   В `DEBUG_INSTRUCTIONS.md` есть информация по скриптам `debug_logs.sh` для анализа логов.

### Prometheus и Grafana
-   Если развернуто с Docker Compose и включены сервисы `prometheus` и `grafana`.
-   Prometheus доступен по адресу `http://<IP_СЕРВЕРА>:9090`.
-   Grafana доступна по адресу `http://<IP_СЕРВЕРА>:3000`. Дашборд может быть в `infra/grafana/dashboards/nota.json`.

### Основные метрики для мониторинга
-   `nota_invoices_total`: Счетчик обработанных инвойсов.
-   `nota_ocr_latency_ms`: Время распознавания OCR.
-   `assistant_latency_ms`: Время обработки команд ассистентом.
-   Количество ошибок API, попадания в кэш.

## 5. Обслуживание

### Резервное копирование
(Основано на `DEPLOYMENT.md`)
Важные данные для бэкапа:
-   Директория `data/` (CSV файлы).
-   Директория `logs/` (если логи пишутся в файлы).
-   Данные Redis (если Redis используется для персистентного хранения, например, алиасов). Для этого можно использовать команду `SAVE` или `BGSAVE` в Redis и копировать дамп-файл.
Пример скрипта для бэкапа (адаптируйте под свою среду):
```bash
#!/bin/bash
BACKUP_DIR="/opt/backups/nota-v3/$(date +%Y%m%d_%H%M%S)"
SOURCE_DIR="/path/to/Nota-v3-" # Путь к приложению
mkdir -p "$BACKUP_DIR"

# Копирование файлов данных
cp -r "$SOURCE_DIR/data" "$BACKUP_DIR/"
# Копирование логов, если они в файлах
# cp -r "$SOURCE_DIR/logs" "$BACKUP_DIR/"

# Если используете Docker и Redis том
# docker-compose exec redis redis-cli SAVE
# docker cp nota-v3-_redis_1:/data/dump.rdb "$BACKUP_DIR/redis_dump.rdb"
echo "Резервное копирование завершено в $BACKUP_DIR"
```

### Управление алиасами
(См. `docs/PROJECT_OVERVIEW.md` - "Работа с алиасами")
Используйте скрипт `tools/manage_aliases.py` (если он актуален и поддерживается):
```bash
# python ./tools/manage_aliases.py list
# python ./tools/manage_aliases.py add --alias "новое имя" --product_id "id123"
# python ./tools/manage_aliases.py delete --alias "старое имя"
```
Убедитесь, что скрипт запускается с правильным окружением и доступом к `data/aliases.csv`.

### Очистка старых логов и данных
-   Настройте ротацию логов (например, через `logrotate` для systemd или Docker logging drivers).
-   Периодически проверяйте размер директории `logs/` и `data/`.
-   Для Redis можно настроить политики вытеснения ключей (eviction policies).

### Обновление до новой версии
(Основано на `DEPLOYMENT.md`)
Для Docker:
```bash
git pull # Получить последнюю версию из нужной ветки
docker-compose down # Остановить текущие контейнеры (с сохранением томов)
docker-compose build nota-bot # Пересобрать образ бота (если есть изменения в коде)
docker-compose up -d # Запустить обновленные контейнеры
```
Для systemd:
```bash
cd /path/to/Nota-v3-
git pull
source venv/bin/activate
pip install -r requirements.txt # Обновить зависимости
sudo systemctl restart nota-bot # Перезапустить сервис
```

## 6. Технические аспекты

### Обработка ошибок API
(См. `docs/technical/API_ERROR_HANDLING.md`)
-   Используются декораторы для повторных попыток с экспоненциальной задержкой (`@with_retry_backoff`, `@with_async_retry_backoff`).
-   Ошибки классифицируются (TIMEOUT, RATE_LIMIT, VALIDATION, etc.).
-   Цель - повышение стабильности и предоставление понятных сообщений пользователю.

### Оптимизации производительности
(См. `docs/technical/PERFORMANCE.md`)
-   Асинхронные вызовы API (`asyncio`, `to_thread`).
-   Оптимизация логирования и кэширования.
-   Асинхронные обработчики и отмена задач для улучшения отклика.
-   Оптимизированная постобработка OCR.

## 7. Устранение неполадок

### Общие проблемы
-   **Проблемы с подключением к Telegram/OpenAI API**: Проверьте сетевые настройки, правильность токенов и ключей, лимиты API.
-   **Недостаток ресурсов сервера**: Мониторьте CPU, память. Для Docker можно настроить лимиты в `docker-compose.yml`.
-   **Ошибки в конфигурации `.env`**: Дважды проверьте все пути, URL, логины и пароли.

### Анализ логов для отладки на сервере
(См. `DEBUG_INSTRUCTIONS.md`)
-   Используйте `docker-compose logs -f nota-bot` или `journalctl -u nota-bot -f`.
-   Для более глубокого анализа можно временно повысить `LOG_LEVEL` до `DEBUG`.
-   Скрипты `stop_background_bot.sh` и `debug_bot.sh` могут быть полезны для запуска бота в интерактивном режиме на сервере (с осторожностью на production!).

## 8. История изменений (Changelog)

(Используйте содержимое `CHANGELOG.md` из корня проекта или `docs/releases/CHANGELOG.md`. Предпочтительно один актуальный файл.)

Пример:
```
## [0.6.0] - 2024-05-14

### Changed
- Refactored OCR pipeline...
### Added
- Increased overall test coverage...
### Fixed
- Fixed failing unit tests...
```
(Здесь должен быть актуальный Changelog)

## 9. Известные проблемы и ограничения

(Взято из `docs/PROJECT_OVERVIEW.md` - "Известные проблемы и ограничения")
1.  **Ограничения OCR**: GPT-4o может не распознавать рукописный текст или очень плохие скан-копии.
2.  **Единицы измерения**: Может отсутствовать автоматическое сопоставление или конвертация единиц измерения.
3.  **Кэширование токенов**: Если токены API кэшируются, они могут истекать.
4.  **Ограничения размера изображений**: Например, до 2MB или 1600px.

(Дополните актуальной информацией)
```
