# Тестирование проекта

## Структура тестов

Тесты в проекте организованы следующим образом:

- `tests/unit/` - юнит-тесты для отдельных компонентов приложения
- `tests/` - общие и интеграционные тесты

## Запуск тестов

### Запуск всех тестов

```bash
pytest
```

### Запуск юнит-тестов

```bash
pytest tests/unit/
```

### Запуск юнит-тестов с отчетом о покрытии

```bash
pytest tests/unit/ --cov=app --cov-report=html
```

### Запуск тестов для конкретного модуля

```bash
pytest tests/unit/test_ocr.py
```

### Запуск тестов с отладочной информацией

```bash
pytest -vs tests/unit/test_ocr.py
```

## Автоматические тесты

Для упрощения запуска всех тестов и генерации отчета о покрытии есть скрипт:

```bash
./tests/unit/run_tests.sh
```

## Модули с низким покрытием тестами

Следующие модули имеют наименьшее покрытие тестами и требуют дополнительных тестов:

1. `app/ocr_pipeline.py` (11%)
2. `app/ocr.py` (76%)
3. `app/postprocessing.py` (74%)
4. `app/matcher.py` (65%)

## Принципы написания тестов

1. **Изоляция** - каждый тест должен быть независим от других тестов
2. **Моки** - для тестирования внешних зависимостей используйте моки
3. **Граничные случаи** - тестируйте граничные случаи и обработку ошибок
4. **Приоритезация** - в первую очередь тестируйте критические компоненты 
5. **Читаемость** - пишите понятные и хорошо документированные тесты

## Фикстуры

В проекте используются следующие фикстуры для тестирования:

- `fake_msg` - мок объекта сообщения Telegram
- `mock_redis` - мок для Redis кеша
- `mock_openai_client` - мок для OpenAI API
- `sample_invoice_data` - тестовые данные накладной
- `sample_image_bytes` - тестовое изображение
- `mock_settings` - тестовые настройки

## Маркеры pytest

Для категоризации тестов используются следующие маркеры:

- `@pytest.mark.unit` - юнит-тесты
- `@pytest.mark.integration` - интеграционные тесты
- `@pytest.mark.slow` - медленные тесты
- `@pytest.mark.vcr` - тесты с VCR.py кассетами

Пример использования:

```python
@pytest.mark.unit
def test_clean_num():
    # test code
```

## Отчет о покрытии

Для генерации отчета о покрытии используется плагин pytest-cov:

```bash
pytest --cov=app --cov-report=html
```

После запуска данной команды отчет будет сгенерирован в директории `htmlcov/`.