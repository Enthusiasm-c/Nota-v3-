# Документация по системе парсеров команд

## Обзор

Система парсеров команд представляет собой модульную структуру для распознавания различных команд пользователя в процессе редактирования инвойсов. Система спроектирована с учетом следующих принципов:

- **Модульность**: Каждый тип команды (дата, строка, и т.д.) имеет свой собственный парсер
- **Расширяемость**: Легко добавить новые типы команд и форматы
- **Логгирование**: Полное логгирование процесса распознавания команд
- **Обратная совместимость**: Полностью совместима с существующим кодом через адаптер

## Структура модулей

```
app/
├── parsers/
│   ├── text_processor.py    # Базовые утилиты обработки текста
│   ├── line_parser.py       # Парсер команд редактирования строк
│   ├── date_parser.py       # Парсер команд редактирования даты
│   ├── command_parser.py    # Интегрированный парсер (точка входа)
│   └── errors.py            # Управление сообщениями об ошибках
└── assistants/
    └── parser_adapter.py    # Адаптер для обратной совместимости
```

## Использование

### Интегрированный парсер

Основная точка входа в систему парсеров - функция `parse_command` в модуле `command_parser.py`:

```python
from app.parsers.command_parser import parse_command

# Парсинг одиночной команды
result = parse_command("строка 1 цена 500", invoice_lines=3)
# -> {"action": "edit_price", "line": 0, "value": 500.0, "source": "local_parser"}

# Для составных команд (несколько команд в одной строке)
from app.parsers.command_parser import parse_compound_command
results = parse_compound_command("строка 1 цена 500; дата 01.02.2023", invoice_lines=3)
# -> [{"action": "edit_price", "line": 0, "value": 500.0, ...}, {"action": "set_date", "value": "2023-02-01", ...}]
```

### Обратная совместимость

Для замены существующей функции `parse_edit_command` используйте функцию `parse_edit_command_enhanced` из модуля `parser_adapter.py`:

```python
from app.assistants.parser_adapter import parse_edit_command_enhanced

# Использовать так же, как и оригинальный parse_edit_command
results = parse_edit_command_enhanced("строка 1 цена 500; дата 01.02.2023", invoice_lines=3)
```

## Поддерживаемые форматы команд

### Команды редактирования строк

- `строка X цена Y` / `line X price Y` - изменение цены
- `строка X название Y` / `line X name Y` - изменение названия
- `строка X количество Y` / `line X qty Y` - изменение количества
- `строка X единица Y` / `line X unit Y` - изменение единицы измерения

### Команды редактирования даты

- `дата DD.MM.YYYY` / `date DD.MM.YYYY` - прямая установка даты
- `дата DD месяц YYYY` / `date DD month YYYY` - установка даты с текстовым месяцем
- `изменить дату на DD.MM.YYYY` / `change date to DD.MM.YYYY` - изменение даты
- `дата YYYY-MM-DD` / `date YYYY-MM-DD` - установка даты в ISO-формате

### Другие команды

Система также поддерживает все команды из предыдущего `free_parser.py`, включая:
- Редактирование поставщика
- Удаление строк
- Добавление новых строк
- Команды завершения

## Обработка ошибок

Система обеспечивает подробные сообщения об ошибках для пользователя:

```python
from app.parsers.errors import get_error_message

# Получить сообщение об ошибке на английском
message_en = get_error_message("invalid_line_number")
# -> "Invalid line number. Please specify a line using a number (e.g., 'line 1')."

# Получить сообщение об ошибке на русском
message_ru = get_error_message("invalid_line_number", lang="ru")
# -> "Неверный номер строки. Пожалуйста, укажите строку с помощью числа (например, 'строка 1')."
```

## Расширение системы

### Добавление нового типа команды

1. Создайте новый модуль в директории `app/parsers/`
2. Реализуйте функцию парсинга по аналогии с существующими модулями
3. Добавьте вызов вашего парсера в `command_parser.py`

### Добавление нового формата команды

1. Добавьте новое регулярное выражение в соответствующий парсер
2. Реализуйте функцию обработки для нового формата
3. Добавьте новые сообщения об ошибках в `errors.py` при необходимости

## Миграция со старой системы

Для постепенной миграции с монолитной функции `parse_edit_command` на новую систему:

1. Сначала используйте `parse_edit_command_enhanced` вместо `parse_edit_command`
2. Постепенно переводите код на прямое использование `parse_command` или `parse_compound_command`
3. Когда все места использования будут переведены, можно будет удалить старую функцию 