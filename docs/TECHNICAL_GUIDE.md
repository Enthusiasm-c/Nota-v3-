# Техническое руководство Nota AI

## Архитектура проекта

### Обзор архитектуры

Nota AI представляет собой Telegram-бота для оцифровки накладных поставщиков с использованием OCR технологий и интеграцией с системой Syrve.

Ключевые технологии:
- Python 3.11
- aiogram 3
- Pydantic 2
- OpenAI SDK ≥1.0
- GPT-4o Vision
- RapidFuzz 3.13
- CSV в качестве хранилища данных
- Docker + systemd для развертывания

### Основные компоненты

1. **Telegram Bot** - точка входа и пользовательский интерфейс
2. **OCR Engine** - распознавание накладных через GPT-4o
3. **Matcher** - сопоставление продуктов с каталогом
4. **Edit Handler** - обработка команд редактирования
5. **Syrve Client** - интеграция с POS-системой ресторана

### Структура проекта

```
nota-optimized/
├── app/                   # Основной код приложения
│   ├── assistants/        # Интеграция с OpenAI API
│   ├── edit/              # Логика редактирования
│   ├── formatters/        # Форматирование отчетов
│   ├── handlers/          # Обработчики Telegram
│   ├── fsm/               # Конечные автоматы состояний
│   ├── imgprep/           # Предобработка изображений
│   └── utils/             # Вспомогательные инструменты
├── data/                  # Каталоги продуктов и алиасы
├── docs/                  # Документация
├── tests/                 # Автотесты
├── scripts/               # Скрипты деплоя и обслуживания
└── prompts/               # Промпты для GPT моделей
```

## Основные процессы обработки

### Жизненный цикл инвойса

1. **Получение фото:**
   - Пользователь отправляет фото в Telegram
   - Бот сохраняет изображение и показывает прогресс-бар

2. **Предобработка изображения:**
   - Ограничение размера до 2 MB / 1600 px
   - Выравнивание документа и улучшение контраста (CLAHE)
   - Шумоподавление и адаптивная бинаризация
   - Сохранение в WebP (≤ 200 kB)

3. **OCR с GPT-4o Vision:**
   - Оптимизированное изображение отправляется в OpenAI API
   - Модель анализирует структуру накладной
   - Результат валидируется через Pydantic

4. **Сопоставление с каталогом:**
   - Продукты сопоставляются с базой через fuzzy-matching
   - Определяется статус каждой позиции (ok, unknown, unit_mismatch)
   - При высоком совпадении (≥90%) автоматически создаются алиасы

5. **Формирование отчета:**
   - Создается форматированный отчет с проблемными позициями
   - Отчет отправляется пользователю с кнопками управления

6. **Редактирование (если необходимо):**
   - Пользователь вводит команды на естественном языке
   - GPT-3.5-turbo преобразует их в структурированные интенты
   - Изменения применяются к данным инвойса

7. **Отправка в Syrve (опционально):**
   - Проверенный инвойс экспортируется в XML
   - Данные отправляются через Syrve API
   - Результат операции возвращается пользователю

### Обработка команд редактирования

1. **Ввод команды пользователем:**
   - Формат: свободный текст (напр. "строка 2 цена 90000")
   - Обрабатывается: даты, цены, названия, количества, единицы измерения

2. **Обработка через GPT-3.5-turbo:**
   - Текст отправляется модели со специальным промптом
   - Модель генерирует структурированный JSON-интент
   - Интент валидируется и применяется к данным

3. **Примеры команд:**
   - Одиночные: "строка 2 цена 95000", "дата 16 апреля"
   - Множественные: "строка 1 цена 200, строка 2 название Молоко"
   - Комбинированные: "дата 10 мая; поставщик ООО Заря"

## Технические особенности и оптимизации

### Обработка изображений

1. **Цели предобработки:**
   - Уменьшение размера для API (≤ 2 MB)
   - Улучшение контраста и четкости текста
   - Устранение шумов и искажений

2. **Основные методы:**
   - **OpenCV:** адаптивная бинаризация, морфологические операции
   - **CLAHE:** адаптивное выравнивание гистограммы с clipLimit
   - **Выравнивание перспективы:** исправление искажений

### Кэширование и оптимизация запросов

1. **TTLCache для API вызовов:**
   - Кэширование результатов OCR по хэшу изображения
   - Существенное ускорение при повторных запросах
   - Настраиваемый TTL через переменные окружения

2. **Thread Pool для OpenAI API:**
   - Параллельная обработка запросов
   - Повторные попытки при ошибках API
   - Детальное логирование задержек

### Мониторинг и логирование

1. **Структурное логирование:**
   - Использование structured JSON logging
   - Поля: module, action, duration, status
   - Полное логирование запросов к OpenAI API

2. **Метрики производительности:**
   - Время распознавания накладных
   - Процент успешно сопоставленных позиций
   - Количество редактирований пользователем

### Тестирование

1. **Покрытие тестами:**
   - Unit-тесты для отдельных модулей
   - Интеграционные тесты с моками API
   - Cassette-tests для OpenAI API

2. **Test-Driven Development:**
   - Разработка новых функций через TDD
   - Тесты редактирования на естественном языке
   - Тестирование исключительных ситуаций 