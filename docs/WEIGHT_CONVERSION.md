# Автоматическое преобразование единиц веса

## Обзор

В систему добавлена функциональность автоматического преобразования различных единиц веса в килограммы для удобства работы с накладными.

## Поддерживаемые единицы

### Граммы
- `g`, `gr`, `gm`, `gram`, `grams`, `gramme`, `grammes`
- `г`, `гр` (русские обозначения)
- **Правило**: Преобразуются в кг только если количество ≥ 1000 г

### Миллиграммы
- `mg`, `мг`
- **Правило**: Преобразуются в кг только если количество ≥ 1 000 000 мг (1 кг)

### Тонны
- `t`, `ton`, `tonne`, `т`
- **Правило**: Всегда преобразуются в кг

### Фунты
- `lb`, `lbs`, `pound`, `pounds`
- **Правило**: Всегда преобразуются в кг (1 фунт = 0.453592 кг)

### Унции
- `oz`, `ounce`, `ounces`
- **Правило**: Всегда преобразуются в кг (1 унция = 0.0283495 кг)

## Как это работает

1. **Автоматическое определение**: Система автоматически определяет единицу измерения веса в накладной

2. **Умное преобразование**: 
   - Граммы преобразуются только если их 1000 или больше
   - Маленькие количества остаются в исходных единицах

3. **Корректировка цены**: При преобразовании автоматически пересчитывается цена за единицу

## Примеры

### Пример 1: Граммы в килограммы
```
Исходно: 2500 g по цене 2.0 за грамм
Результат: 2.5 kg по цене 2000.0 за килограмм
```

### Пример 2: Граммы остаются граммами
```
Исходно: 500 g по цене 2.0 за грамм
Результат: 500 g по цене 2.0 за грамм (не преобразуется, т.к. < 1000)
```

### Пример 3: Тонны в килограммы
```
Исходно: 0.5 t по цене 1000.0 за тонну
Результат: 500 kg по цене 1.0 за килограмм
```

### Пример 4: Фунты в килограммы
```
Исходно: 10 lb по цене 5.0 за фунт
Результат: 4.536 kg по цене 11.02 за килограмм
```

## Использование в коде

### Функции в `app/utils/data_utils.py`:

```python
# Проверить, нужно ли преобразовывать
if should_convert_to_kg(quantity, unit):
    # Преобразовать
    new_qty, new_unit, new_price = convert_weight_to_kg(quantity, unit, price)
```

### Автоматическое применение в postprocessing:

Функция `postprocess_parsed_data` автоматически применяет преобразование ко всем позициям в накладной.

## Настройки

Пороговые значения для преобразования можно изменить в функции `should_convert_to_kg`:
- Граммы: 1000 г (1 кг)
- Миллиграммы: 1 000 000 мг (1 кг)

## Преимущества

1. **Единообразие**: Все весовые товары в накладных приводятся к килограммам
2. **Удобство**: Не нужно вручную пересчитывать граммы в килограммы
3. **Точность**: Автоматический пересчет цен исключает ошибки
4. **Гибкость**: Маленькие количества остаются в удобных единицах

## Ограничения

- Преобразование работает только для весовых единиц
- Объемные единицы (литры, миллилитры) не преобразуются
- Штучные товары (pcs, шт) не затрагиваются