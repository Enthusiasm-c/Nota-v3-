# Nota AI - Техническая документация

## Обзор проекта

Nota AI - это автоматизированный бот для Telegram, предназначенный для быстрого и точного преобразования бумажных инвойсов поставщиков в цифровой формат для последующей интеграции с системой управления рестораном Syrve. Проект решает проблему ручного ввода данных, снижая количество ошибок и экономя время персонала.

### Основные возможности

1. **Распознавание инвойсов** с помощью GPT-4o (OCR)
2. **Предобработка изображений** для улучшения качества распознавания
3. **Сопоставление позиций** с каталогом продуктов
4. **Интерактивное редактирование** выявленных ошибок или несоответствий
5. **Многокомандное редактирование** для быстрой коррекции
6. **Интеграция с Syrve** для отправки проверенных накладных
7. **Многоязычный интерфейс** (английский, русский)
8. **Мониторинг и метрики** для анализа производительности

## Архитектура проекта

### Общая структура

```
Nota-v3-/
├── app/                   # Основной код приложения
│   ├── i18n/              # Система локализации
│   ├── assistants/        # Интеграция с OpenAI Assistant API
│   ├── core/              # Базовая функциональность
│   ├── edit/              # Логика редактирования
│   ├── formatters/        # Форматирование отчетов и данных
│   ├── fsm/               # Конечные автоматы состояний
│   ├── handlers/          # Обработчики сообщений Telegram
│   ├── imgprep/           # Предобработка изображений
│   └── utils/             # Вспомогательные инструменты
├── data/                  # Каталоги продуктов, алиасы и т.д.
├── docs/                  # Документация
├── infra/                 # Инфраструктурные компоненты
│   ├── cron/              # Задачи по расписанию
│   └── grafana/           # Дашборды мониторинга
├── prompts/               # Промпты для GPT моделей
├── scripts/               # Вспомогательные скрипты
├── tests/                 # Тесты
└── tools/                 # Утилиты для управления проектом
```

### Ключевые компоненты

1. **Telegram Bot** - интерфейс взаимодействия с пользователем
2. **FSM (Finite State Machine)** - управление состояниями диалога
3. **OCR Engine** - распознавание текста на изображениях (GPT-4o)
4. **Matcher** - система сопоставления позиций с каталогом
5. **Edit Handler** - обработка команд редактирования
6. **Syrve Client** - интеграция с POS системой
7. **Monitoring** - сбор метрик и мониторинг

## Жизненный цикл обработки инвойса

### 1. Получение изображения

1. Пользователь отправляет фото инвойса в чат
2. Бот сохраняет изображение во временное хранилище
3. Начинается процесс предобработки и распознавания

### 2. Предобработка изображения

1. Ограничение размера (максимум 2 MB / 1600 px)
2. Обнаружение и выравнивание документа
3. Улучшение контраста (CLAHE с адаптивным clipLimit)
4. Шумоподавление
5. Адаптивная бинаризация и морфологические операции
6. Сохранение в формате WebP (качество 90%, до 200 kB)

### 3. OCR и извлечение данных

1. Обработанное изображение отправляется в GPT-4o
2. Модель анализирует изображение и извлекает структурированные данные
3. Результат парсится и преобразуется в структуру ParsedData

### 4. Сопоставление с каталогом

1. Для каждой строки извлеченного инвойса:
   - Поиск соответствующего продукта в каталоге
   - Вычисление степени соответствия (0-100%)
   - Определение статуса (ok, unknown, unit_mismatch)
2. Если совпадение ≥90%, автоматическое создание алиаса
3. Формирование отчета с указанием проблемных позиций

### 5. Интерактивное редактирование

1. Пользователь получает отчет об инвойсе с указанием проблем
2. Доступны кнопки для редактирования, отмены или подтверждения
3. При выборе "Редактировать":
   - Пользователь может вводить команды (напр. "строка 2 цена 100")
   - Поддерживается множественное редактирование ("строка 1 цена 200, строка 2 название Молоко")
   - Для неопознанных позиций предлагаются inline-подсказки

### 6. Интеграция с Syrve

1. При подтверждении инвойса формируется XML-документ
2. Выполняется аутентификация в Syrve API
3. XML отправляется через API метод import_invoice
4. Результат обработки возвращается пользователю
5. Информация логируется и записывается в метрики

## Инструкция по развертыванию

### Требования

- Python 3.10+
- Redis
- Prometheus (опционально)
- Grafana (опционально)

### Переменные окружения

```
# OpenAI API
OPENAI_OCR_KEY=sk-...
OPENAI_CHAT_KEY=sk-...
OPENAI_ASSISTANT_ID=asst_...

# Telegram Bot
TELEGRAM_TOKEN=...

# Syrve API
SYRVE_API_URL=https://api.syrve.com
SYRVE_LOGIN=api_user
SYRVE_PASSWORD=...
SYRVE_CONCEPTION_ID=...
SYRVE_STORE_ID=...
SYRVE_DEFAULT_SUPPLIER_ID=...

# Redis (опционально)
REDIS_URL=redis://localhost:6379/0

# Мониторинг (опционально)
ADMIN_CHAT_ID=...
```

### Установка и запуск

```bash
# Клонирование репозитория
git clone https://github.com/username/Nota-v3-.git
cd Nota-v3-

# Создание виртуального окружения
python -m venv venv
source venv/bin/activate

# Установка зависимостей
pip install -r requirements.txt

# Запуск бота
python bot.py
```

### Настройка cron-задач

```bash
# Добавить в crontab
0 3 * * * /path/to/Nota-v3-/infra/cron/cleanup.sh
```

## Основные модули и их функции

### app/assistants/

Обеспечивает взаимодействие с OpenAI Assistant API для обработки команд пользователя и распознавания документов.

- **client.py** - клиент для OpenAI API
- **thread_pool.py** - пул потоков Assistant API для ускорения
- **intent_adapter.py** - преобразование ответов Assistant API в структурированный формат

### app/edit/

Управляет логикой редактирования инвойса после распознавания.

- **apply_intent.py** - применение команд редактирования к данным инвойса
- **free_parser.py** - парсер свободных команд редактирования

### app/fsm/

Управление конечными автоматами состояний для диалога с пользователем.

- **states.py** - определение всех состояний бота

### app/handlers/

Обработчики сообщений и коллбэков от пользователя.

- **edit_flow.py** - обработка редактирования инвойса
- **incremental_photo_handler.py** - обработка загрузки фото с прогрессивным UI
- **name_picker.py** - обработка подсказок при неопознанных позициях
- **syrve_handler.py** - интеграция с Syrve и отправка накладных

### app/i18n/

Система локализации для поддержки разных языков.

- **__init__.py** - функции для работы с переводами
- **texts_en.yaml** - английские строки интерфейса

### app/imgprep/

Модуль предобработки изображений для улучшения результатов OCR.

- **prepare.py** - функции обработки изображений

### app/utils/

Вспомогательные утилиты и инструменты.

- **api_decorators.py** - декораторы для работы с API
- **redis_cache.py** - кэширование данных в Redis
- **monitor.py** - сбор метрик и мониторинг

## Классы и функции

### Ключевые классы

- **SyrveClient** - клиент для взаимодействия с Syrve API
- **IncrementalUI** - класс для пошаговых обновлений UI
- **EditCommand** - модель команды редактирования
- **ParsedData** - модель данных распознанного инвойса

### Важные функции

- **prepare_for_ocr()** - предобработка изображения для OCR
- **call_openai_ocr()** - распознавание текста с помощью OpenAI API
- **match_positions()** - сопоставление позиций с каталогом
- **fuzzy_find()** - нечеткий поиск товаров по названию
- **apply_intent()** - применение команды редактирования
- **t()** - функция для локализации строк

## Настройка конфигурации

Конфигурация проекта основана на переменных окружения и файлах:

- **settings.py** - основные настройки приложения
- **.env** - переменные окружения (локальная разработка)
- **data/aliases.csv** - алиасы продуктов
- **data/base_products.csv** - каталог продуктов

## Работа с алиасами

Алиасы - это альтернативные названия продуктов, которые помогают улучшить качество сопоставления. Алиасы хранятся в файле `data/aliases.csv`.

Управление алиасами:
```bash
# Просмотр всех алиасов
./tools/manage_aliases.py list

# Добавление нового алиаса
./tools/manage_aliases.py add --alias "яблоки красные" --product_id "abc123"

# Удаление алиаса
./tools/manage_aliases.py delete --alias "яблоки красные"
```

## Мониторинг и метрики

Проект включает набор метрик Prometheus для мониторинга производительности:

- **nota_invoices_total** - счетчик обработанных инвойсов (по статусу)
- **nota_ocr_latency_ms** - время распознавания OCR
- **assistant_latency_ms** - время обработки командам ассистентом
- **fuzzy_suggestions** - статистика нечетких совпадений

Графана-дашборд доступен в `infra/grafana/dashboards/nota.json`.

## Тестирование

Проект включает более 160 тестов, покрывающих основную функциональность:

```bash
# Запуск всех тестов
pytest

# Запуск конкретного модуля тестов
pytest tests/test_matcher.py

# Запуск тестов с подробным выводом
pytest -v
```

## Советы по разработке

1. **Локализация**: Всегда используйте функцию `t()` для текстовых строк интерфейса.
2. **Обработка ошибок**: Используйте декораторы из `app/utils/api_decorators.py` для API-запросов.
3. **Логирование**: Используйте стандартный модуль `logging` с правильными уровнями.
4. **Кэширование**: Используйте `cache_set` и `cache_get` для кэширования данных.
5. **Метрики**: Используйте `increment_counter` и `record_histogram` для записи метрик.

## Расширение функциональности

### Добавление нового обработчика

1. Создайте новый файл в `app/handlers/`
2. Определите Router: `router = Router()`
3. Добавьте обработчики с декораторами `@router.message()` или `@router.callback_query()`
4. Зарегистрируйте роутер в bot.py: `dp.include_router(your_router)`

### Добавление нового языка

1. Создайте файл `app/i18n/texts_XX.yaml` (где XX - код языка)
2. Скопируйте структуру из `texts_en.yaml` и переведите все строки
3. Добавьте поддержку выбора языка в пользовательский интерфейс

### Интеграция с новой системой

1. Создайте новый файл с клиентом API (по аналогии с `syrve_client.py`)
2. Реализуйте необходимые методы для взаимодействия
3. Добавьте новый обработчик для управления интеграцией

## Известные проблемы и ограничения

1. **Ограничения OCR**: GPT-4o может не распознавать рукописный текст или очень плохие скан-копии.
2. **Единицы измерения**: Не существует автоматического сопоставления единиц измерения.
3. **Кэширование токенов**: Токены хранятся в Redis с TTL 45 минут, что может привести к необходимости повторной аутентификации.
4. **Ограничения размера**: Изображения ограничены размером 2MB или 1600px по максимальному измерению.

## Дальнейшее развитие

1. **Массовая загрузка**: Поддержка загрузки нескольких инвойсов за раз.
2. **ML-модели для предобработки**: Использование специализированных моделей для улучшения изображений.
3. **Автоматическое сопоставление единиц**: Интеллектуальное конвертирование единиц измерения.
4. **Расширенная аналитика**: Более детальная статистика и отчеты.
5. **Web-интерфейс**: Разработка веб-панели управления для администраторов.

## Заключение

Nota AI представляет собой комплексное решение для автоматизации процесса ввода данных из бумажных инвойсов в систему управления рестораном. Благодаря использованию современных технологий машинного обучения и компьютерного зрения, система обеспечивает высокую точность распознавания и удобство взаимодействия для пользователей.