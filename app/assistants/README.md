# Модуль интеграции с OpenAI Assistant API

Этот модуль предоставляет инструменты для взаимодействия с OpenAI Assistant API и обработки ответов в контексте редактирования инвойсов для бота Nota.

## Основные компоненты

### client.py

Основной интерфейс для работы с OpenAI Assistant API. Реализует:

- Кеширование ID потоков и ассистентов для оптимизации запросов
- Обработку ошибок и таймаутов при взаимодействии с API
- Расширенное логирование для мониторинга и диагностики
- Извлечение и обработка JSON-команд из ответов API

Ключевая функция:
```python
def run_thread_safe(user_input: str, timeout: int = 60) -> Dict[str, Any]:
    """
    Безопасный запуск OpenAI Thread с обработкой ошибок и таймаутом.

    Args:
        user_input: Текстовая команда пользователя
        timeout: Максимальное время ожидания в секундах

    Returns:
        Dict: JSON-объект с результатом разбора команды
    """
```

### intent_adapter.py

Промежуточный слой между API и системой редактирования, который обеспечивает:

- Нормализацию ответов API в единый формат команд
- Валидацию и преобразование полей
- Извлечение JSON из текстовых ответов
- Механизм восстановления при получении некорректных форматов

Основные методы:

```python
def adapt_intent(response: Union[str, Dict[str, Any]]) -> Dict[str, Any]:
    """
    Адаптирует ответ от OpenAI Assistant API в валидный формат команд.

    Args:
        response: Ответ от OpenAI (строка или словарь)

    Returns:
        Dict: Нормализованная команда
    """
```

## Формат команд для редактирования

Система поддерживает следующие действия (поле `action`):

1. `set_date` - установка даты инвойса
   - Требуемые поля: `value` (дата в формате YYYY-MM-DD)

2. `set_price` - установка цены для позиции
   - Требуемые поля: `line_index` (индекс позиции, начиная с 0), `value` (цена)

3. `set_name` - установка названия для позиции
   - Требуемые поля: `line_index` (индекс позиции, начиная с 0), `value` (название)

4. `set_quantity` - установка количества для позиции
   - Требуемые поля: `line_index` (индекс позиции, начиная с 0), `value` (количество)

5. `set_unit` - установка единицы измерения для позиции
   - Требуемые поля: `line_index` (индекс позиции, начиная с 0), `value` (единица измерения)

6. `add_line` - добавление новой позиции в инвойс
   - Требуемые поля: `name` (название), `qty` (количество), `unit` (единица), `price` (цена)

## Промпты для OpenAI Assistant

Для работы с OpenAI Assistant используются специальные промпты, которые находятся в директории:
`/prompts/edit_assistant_v1.0.txt`

Эти промпты содержат инструкции для модели, форматы ответов и примеры для лучшего понимания команд редактирования.

## Примеры использования

### Базовый пример:

```python
from app.assistants.client import run_thread_safe

# Запрос пользователя на естественном языке
user_text = "строка 2 цена 95000"

# Получаем структурированную команду
intent = run_thread_safe(user_text)

# Проверяем успешность разбора
if intent.get("action") != "unknown":
    # Применяем интент к инвойсу
    new_invoice = apply_intent(invoice, intent)
```

### Пример с адаптером:

```python
from app.assistants.intent_adapter import adapt_intent

# Адаптируем произвольный текст или JSON
intent = adapt_intent('{"action": "set_price", "line": 2, "price": "95000"}')

# intent теперь будет содержать:
# {
#     "action": "set_price",
#     "line_index": 1,  # преобразовано из line=2 (1-based) в line_index=1 (0-based)
#     "value": "95000"  # преобразовано из price в value
# }
```

## Обработка ошибок

Система обрабатывает различные типы ошибок:

1. Ошибки API (таймауты, авторизация и т.д.)
2. Ошибки формата ответа (некорректный JSON, отсутствующие поля)
3. Ошибки применения команд (некорректные индексы строк, некорректные значения)

В случае ошибки возвращается объект с полями:
```python
{
    "action": "unknown",
    "error": "описание_ошибки",
    "user_message": "сообщение для пользователя"
}
```
