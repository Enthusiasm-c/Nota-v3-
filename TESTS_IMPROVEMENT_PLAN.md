# План по исправлению и улучшению тестового покрытия

## 1. Анализ и исправление существующих тестов

### 1.1. Исправление ошибок импорта и синтаксических ошибок
- Добавить импорт `import httpx` в файл test_syrve_export.py
- Проверить остальные файлы на аналогичные ошибки отсутствующих импортов
- Исправить все синтаксические ошибки в тестах

### 1.2. Проверка зависимостей тестов
- Составить полный список зависимостей, используемых в тестах
- Убедиться, что все зависимости установлены в корректных версиях
- Создать файл requirements-dev.txt для тестовых зависимостей

### 1.3. Анализ причин падения тестов
- Запустить тесты с детальным выводом (`pytest -v tests/`)
- Категоризировать ошибки по типам (импорт, функциональность, окружение)
- Определить, какие тесты критичны для функциональности ядра

## 2. Улучшение среды тестирования

### 2.1. Настройка окружения
- Создать файл .env.test с необходимыми переменными окружения для тестов
- Использовать моки для внешних зависимостей вместо реальных вызовов API
- Настроить изолированную тестовую среду для всех тестов

### 2.2. Оптимизация конфигурации pytest
- Настроить conftest.py для централизованной настройки тестов
- Использовать фикстуры для инициализации общих объектов
- Настроить маркеры для категоризации тестов (unit, integration, slow)

## 3. Стратегия по увеличению покрытия кода

### 3.1. Анализ текущего покрытия
- Сгенерировать подробный отчёт о покрытии (`pytest --cov=app --cov-report=html`)
- Идентифицировать ключевые модули с наименьшим покрытием
- Определить приоритеты для увеличения покрытия

### 3.2. Разработка новых тестов
- Начать с модулей, реализующих основную функциональность ядра
- Сосредоточиться на следующих модулях с низким покрытием:
  - app/ocr.py (покрытие 22%)
  - app/postprocessing.py (покрытие 9%)
  - app/matcher.py (покрытие 9%) 
  - app/ocr_pipeline.py (покрытие 0%)

### 3.3. Создание тестов для модуля OCR
- Написать тесты для функции call_openai_ocr
- Создать моки для ответов OpenAI API
- Проверить различные варианты ответов и обработку ошибок

### 3.4. Создание тестов для модуля постобработки
- Написать тесты для функции postprocess_parsed_data
- Тестировать различные варианты преобразования данных
- Проверить граничные случаи и обработку исключений

### 3.5. Создание тестов для модуля матчинга
- Написать тесты для функций match_positions и match_supplier
- Тестировать различные алгоритмы сопоставления
- Проверить работу с различными входными данными

### 3.6. Создание тестов для OCR pipeline
- Написать тесты для всего процесса OCR
- Создать тесты для обработки изображений и извлечения данных
- Проверить интеграцию различных компонентов системы

## 4. Оптимизация и стабилизация

### 4.1. Улучшение существующих тестов
- Рефакторинг сложных тестов для улучшения читаемости
- Разделение интеграционных тестов на более мелкие блоки
- Добавление ясных сообщений об ошибках

### 4.2. Ускорение запуска тестов
- Использовать параллельное выполнение тестов (pytest-xdist)
- Метки для пропуска медленных тестов при быстрых проверках
- Оптимизация тяжелых тестов

### 4.3. Настройка CI/CD для тестов
- Настроить GitHub Actions для автоматического запуска тестов при коммитах
- Настроить проверку покрытия в CI/CD pipeline
- Установить порог прохождения тестов на уровне 75% покрытия

## 5. Документирование и обучение

### 5.1. Создание документации по тестам
- Описать порядок запуска тестов и интерпретации результатов
- Стандартизировать формат написания новых тестов
- Создать руководство по добавлению тестов

### 5.2. Периодический аудит тестового покрытия
- Настроить регулярное обновление отчёта о покрытии
- Следить за изменениями покрытия при добавлении новой функциональности
- Установить цели по покрытию для каждого модуля 