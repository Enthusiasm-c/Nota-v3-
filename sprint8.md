# Пошаговый план внедрения новой UI-архитектуры

## Этап 1: Создание базовой UI-службы (3-5 дней)

1. **Создать структуру директорий**
   ```bash
   mkdir -p app/ui/
   touch app/ui/__init__.py
   touch app/ui/service.py
   touch app/ui/keyboard_factory.py
   ```

2. **Создать основной класс UI в service.py**
   - Реализовать базовые методы: start, update, complete, error
   - Добавить поддержку split_message для длинных сообщений
   - Интегрировать optimized_safe_edit
   - Добавить обработку HTML-форматирования

3. **Написать тесты для UI-службы**
   ```bash
   touch tests/test_ui_service.py
   ```
   - Тесты для start/update/complete
   - Тесты для split_and_send
   - Тесты для обработки ошибок HTML

4. **Создать фабрику клавиатур**
   - Реализовать KeyboardFactory в keyboard_factory.py
   - Перенести все шаблоны клавиатур из app/keyboards.py
   - Добавить поддержку i18n при генерации кнопок

## Этап 2: Реорганизация FSM-состояний (2-3 дня)

1. **Создать новую структуру состояний**
   ```bash
   touch app/fsm/flow_states.py
   ```
   - Реализовать InvoiceFlow (главное дерево состояний)
   - Реализовать TalkFlow (для диалога с ассистентом)
   - Добавить сервисные методы для перехода между состояниями

2. **Создать контекст сессии (SessionContext)**
   ```bash
   touch app/fsm/session_context.py
   ```
   - Класс для обертки над FSMContext
   - Добавление UI и lang как стандартных атрибутов
   - Вспомогательные методы для работы с состоянием

3. **Написать миграционный скрипт**
   ```bash
   touch tools/migrate_states.py
   ```
   - Скрипт для конвертации старых состояний в новые

## Этап 3: Миграция обработчиков фото (3-4 дня)

1. **Создать новый обработчик фото, использующий UI-службу**
   ```bash
   touch app/handlers/photo_flow.py
   ```
   - Реализовать с использованием SessionContext и UI
   - Адаптировать логику обработки из incremental_photo_handler.py
   - Добавить единую обработку отмены

2. **Написать тесты для нового обработчика**
   ```bash
   touch tests/test_photo_flow.py
   ```

3. **Переключить маршрутизацию на новый обработчик**
   - Обновить register_handlers в bot.py
   - Добавить отладочное логирование для мониторинга

## Этап 4: Миграция обработчиков редактирования (3-4 дня)

1. **Создать новый обработчик свободного редактирования**
   ```bash
   touch app/handlers/edit_flow_unified.py
   ```
   - Переписать с использованием UI-службы
   - Объединить логику из edit_flow.py и incremental_edit_flow.py

2. **Написать тесты для нового обработчика редактирования**
   ```bash
   touch tests/test_edit_flow_unified.py
   ```

3. **Переключить маршрутизацию на новый обработчик**
   - Обновить register_handlers в bot.py

## Этап 5: Унификация обработчиков отмены (1-2 дня)

1. **Создать единый обработчик отмены**
   ```bash
   touch app/handlers/cancel_flow.py
   ```
   - Реализовать единую логику для всех видов отмены
   - Интегрировать с task_manager для отмены задач

2. **Удалить дублирующиеся обработчики**
   - Удалить старые обработчики отмены в различных модулях
   - Обновить маршрутизацию в bot.py

## Этап 6: Очистка кода и оптимизация (2-3 дня)

1. **Удалить устаревшие компоненты**
   ```bash
   # Переместить в архив или удалить
   mv app/handlers/incremental_photo_handler.py app/handlers/_old/
   mv app/handlers/edit_flow.py app/handlers/_old/
   mv app/handlers/incremental_edit_flow.py app/handlers/_old/
   ```

2. **Обновить документацию**
   - Обновить комментарии в коде
   - Добавить примеры использования нового UI
   - Обновить README.md с новой структурой проекта

3. **Оптимизировать импорты**
   - Устранить циклические импорты
   - Организовать структуру импортов (стандартные → сторонние → внутренние)

## Этап 7: Развертывание и мониторинг (2-3 дня)

1. **Развернуть тестовую версию**
   - Создать тестовый бот для проверки изменений
   - Провести функциональное тестирование

2. **Настроить мониторинг**
   - Добавить логирование ключевых точек UI-взаимодействия
   - Настроить алерты на ошибки UI

3. **Полное развертывание**
   - Обновить prod-версию
   - Мониторить пользовательские ошибки
   - Собирать метрики пользовательского опыта

## Общий план по файлам:

### Новые файлы:
- app/ui/service.py
- app/ui/keyboard_factory.py
- app/fsm/flow_states.py
- app/fsm/session_context.py
- app/handlers/photo_flow.py
- app/handlers/edit_flow_unified.py
- app/handlers/cancel_flow.py
- tests/test_ui_service.py
- tests/test_photo_flow.py
- tests/test_edit_flow_unified.py

### Модифицируемые файлы:
- bot.py (обновить регистрацию хендлеров)
- app/fsm/states.py (обновить или заменить на flow_states.py)
- app/keyboards.py (перенести в keyboard_factory.py)
- app/utils/optimized_safe_edit.py (интегрировать в UI-службу)

### Удаляемые/архивируемые файлы:
- app/handlers/incremental_photo_handler.py
- app/handlers/edit_flow.py
- app/handlers/incremental_edit_flow.py
- app/utils/incremental_ui_example.py (функционал в UI-службе)

---

## Текущие проблемы и их решение

### Проблема: Дублирование обработчиков
- **Текущее состояние:** Несколько обработчиков для одних и тех же действий (edit:free, cancel:all)
- **Решение:** Единые обработчики с контекстом сессии, учитывающим текущее состояние

### Проблема: Три способа вывода сообщений
- **Текущее состояние:** message.answer, safe_edit, IncrementalUI
- **Решение:** Унифицированный класс UI, инкапсулирующий все виды взаимодействия

### Проблема: Длинные сообщения и HTML-форматирование
- **Текущее состояние:** Ручное разбиение, отдельные try-except блоки
- **Решение:** Автоматическое разбиение и обработка HTML в классе UI

### Проблема: Отмена процессов
- **Текущее состояние:** Различные обработчики отмены, не всегда сбрасывающие задачу
- **Решение:** Единый cancel_flow, интегрированный с task_manager

### Проблема: Сложная FSM-структура
- **Текущее состояние:** Несколько перекрывающихся классов состояний
- **Решение:** Иерархическая структура состояний с контекстом сессии

### Проблема: i18n не во всех местах
- **Текущее состояние:** Частичное применение t()
- **Решение:** Централизованная локализация через UI и KeyboardFactory 