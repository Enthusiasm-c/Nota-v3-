#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ Telegram –±–æ—Ç–∞
# –£–±–∏–≤–∞–µ—Ç –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –Ω–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä

set -e  # –ü—Ä–µ–∫—Ä–∞—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "üîÑ –ó–∞–ø—É—Å–∫ Nota AI Telegram Bot..."

# 1. –£–±–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–∞ (–±–æ–ª–µ–µ —à–∏—Ä–æ–∫–∏–π –ø–æ–∏—Å–∫)
echo "üî™ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–æ—Ç–∞..."

# –ò—â–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –ø–æ —Ä–∞–∑–Ω—ã–º –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º
pkill -f "python.*bot\.py" || true
pkill -f "Python.*bot\.py" || true
pkill -f "bot\.py" || true

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∏—â–µ–º –ø–æ PID –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ—Ü–µ—Å—Å—ã —Å –ø–æ–ª–Ω—ã–º –ø—É—Ç–µ–º
BOT_PIDS=$(ps aux | grep -E "(Python|python).*bot\.py" | grep -v grep | awk '{print $2}' || true)
if [ ! -z "$BOT_PIDS" ]; then
    echo "üîç –ù–∞–π–¥–µ–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã: $BOT_PIDS"
    for pid in $BOT_PIDS; do
        kill $pid 2>/dev/null || true
    done
fi

# –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ —á—Ç–æ–±—ã –ø—Ä–æ—Ü–µ—Å—Å—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å
sleep 3

# 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω—ã
BOT_PROCESSES=$(ps aux | grep -E "(Python|python).*bot\.py" | grep -v grep | wc -l)
if [ "$BOT_PROCESSES" -gt 0 ]; then
    echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω—ã –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É–±–∏–≤–∞–µ–º..."

    # –ü–æ–ª—É—á–∞–µ–º PID –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–æ—Ç–∞
    REMAINING_PIDS=$(ps aux | grep -E "(Python|python).*bot\.py" | grep -v grep | awk '{print $2}' || true)
    if [ ! -z "$REMAINING_PIDS" ]; then
        echo "üîç –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ–º PIDs: $REMAINING_PIDS"
        for pid in $REMAINING_PIDS; do
            kill -9 $pid 2>/dev/null || true
        done
    fi

    pkill -9 -f "bot\.py" || true
    sleep 1
fi

# 3. –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –Ω–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
REMAINING=$(ps aux | grep -E "(Python|python).*bot\.py" | grep -v grep | wc -l)
if [ "$REMAINING" -gt 0 ]; then
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–∞!"
    echo "üîç –û—Å—Ç–∞–≤—à–∏–µ—Å—è –ø—Ä–æ—Ü–µ—Å—Å—ã:"
    ps aux | grep -E "(Python|python).*bot\.py" | grep -v grep
    exit 1
fi

echo "‚úÖ –í—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã"

# 4. –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤ –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
mkdir -p logs

# 5. –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤–æ–≥–æ –±–æ—Ç–∞..."
python bot.py &

# –ü–æ–ª—É—á–∞–µ–º PID –Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
BOT_PID=$!
echo "üìã –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω —Å PID: $BOT_PID"

# 6. –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –±–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
sleep 5

if kill -0 $BOT_PID 2>/dev/null; then
    echo "‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç"
    echo "üìÑ –õ–æ–≥–∏: tail -f logs/bot.log"
    echo "üîß –û—Å—Ç–∞–Ω–æ–≤–∫–∞: ./stop_bot.sh"

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ —Ç–µ–ø–µ—Ä—å –∑–∞–ø—É—â–µ–Ω —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø—Ä–æ—Ü–µ—Å—Å
    FINAL_COUNT=$(ps aux | grep -E "(Python|python).*bot\.py" | grep -v grep | wc -l)
    echo "üìä –ó–∞–ø—É—â–µ–Ω–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–æ—Ç–∞: $FINAL_COUNT"
else
    echo "‚ùå –ë–æ—Ç –Ω–µ —Å–º–æ–≥ –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏"
    exit 1
fi
